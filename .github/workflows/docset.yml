name: Check latest Optuna release and build docset
on: [ workflow_dispatch ]
# on:
  # schedule:
  #   - cron: "0 0 * * *"

jobs:
  fetch:
    name: Check latest Optuna release and build docset
    runs-on: ubuntu-latest
    outputs:
      latest: ${{ steps.latest.outputs.version }}
      current: ${{ steps.current.outputs.version }}
    steps:
      - name: get the latest optuna release tag
        id: latest
        run: |
          version=$(curl -s "${GITHUB_API_URL}/repos/optuna/optuna/releases/latest" | jq -r '.["tag_name"]')
          echo ::set-output "name=version::$version"
          echo latest verion: $version
      - name: get current .version
        id: current
        run: |
          echo ::set-output "name=version::$(cat .version)"
          echo current verion: $version
  build:
    runs-on: ubuntu-latest
    needs: fetch
    name: Build HTML document
    if: ${{ needs.fetch.outputs.latest != needs.fetch.outputs.current }}
    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false
      - uses: actions/setup-python@v2
        with:
          python-version: 3.7
      - name: checkout the latest release
        run: |
          git clone --depth 1 --branch ${{ needs.fetch.outputs.latest }} https://github.com/optuna/optuna.git
      - name: install dependencies
        run: |
          cd optuna
          python -m pip install -U pip
          pip install --progress-bar off -U .[document]
      - name: Build Document
        run: |
          cd optuna/docs
          make html
      - uses: actions/upload-artifact@v2
        with:
          name: built-html
          path: |
              optuna/docs/build/html
  docset:
    runs-on: ubuntu-latest
    needs: build
    name: Convert to docset
    steps:
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - uses: actions/download-artifact@v2
        with:
          name: built-html
      - name: install doc2dash
        run: |
          python -m pip install -U pip
          pip install doc2dash
      - name: convert HTML to docset
        run: |
          doc2dash -n optuna -u https://optuna.readthedocs.io optuna/docs/build/html